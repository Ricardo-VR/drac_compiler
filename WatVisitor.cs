using System;
using System.Text;
using System.Collections.Generic;

namespace drac {

    class WatVisitor {
        IDictionary<string, FunctionProperties> tableFunctions;
        HashSet<string> globalVars;
        HashSet<string> primiiveFunctions = new HashSet<string>();
        int labelCounter = 0;

        public string GenerateLabel() {
            return $"${labelCounter++:00000}";
        }

        public WatVisitor(IDictionary<string, FunctionProperties> tableFunctions, HashSet<string> globalVars){
            this.tableFunctions = tableFunctions;
            this.globalVars = globalVars;

            primiiveFunctions.Add("printi");
            primiiveFunctions.Add("printc");
            primiiveFunctions.Add("prints");
            primiiveFunctions.Add("println");
            primiiveFunctions.Add("readi");
            primiiveFunctions.Add("reads");
            primiiveFunctions.Add("new");
            primiiveFunctions.Add("size");
            primiiveFunctions.Add("add");
            primiiveFunctions.Add("get");
            primiiveFunctions.Add("set");

        }

        public string Visit(DefList node){
            return ";; WebAssembly text format code generated by "
                + "the drac compiler.\n\n"
                + "(module\n" 
                + "  (import \"drac\" \"printi\" (func $printi (param i32) (result i32)))\n"
                + "  (import \"drac\" \"printc\" (func $printc (param i32) (result i32)))\n"
                + "  (import \"drac\" \"prints\" (func $prints (param i32) (result i32)))\n"
                + "  (import \"drac\" \"println\" (func $println (result i32)))\n"
                + "  (import \"drac\" \"readi\" (func $readi (result i32)))\n"
                + "  (import \"drac\" \"reads\" (func $reads (result i32)))\n"
                + "  (import \"drac\" \"new\" (func $new (param i32) (result i32)))\n"
                + "  (import \"drac\" \"size\" (func $size (param i32) (result i32)))\n"
                + "  (import \"drac\" \"add\" (func $add (param i32 i32) (result i32)))\n"
                + "  (import \"drac\" \"get\" (func $get (param i32 i32) (result i32)))\n"
                + "  (import \"drac\" \"set\" (func $set (param i32 i32 i32) (result i32)))\n"
                + VisitChildren((dynamic) node)
                + ")\n";
        }

        public string visit(VarDef node){
            var sb = new StringBuilder();
            var globalVarName = node.AnchorToken.Lexeme;

            foreach (var identNode in node[0]){
                sb.Append($"(global  ${globalVarName} (mut i32) (i32.const 0))\n");
            }

            return sb.ToString();
        }

        public string Visit(FunDef node){
            var sb = new StringBuilder();

            sb.Append($"  (func\n  (export \"${node.AnchorToken.Lexeme}\")\n");

            sb.Append(Visit((dynamic) node[0])
            + "  (result i32)\n" 
            + Visit((dynamic) node[1])
            + Visit((dynamic) node[2])
            + "  )\n");
            
            return sb.ToString();
        }

        public string Visit(IdList node){
            //TODO
            return "";
        }

        public string Visit(Identifier node){
            //TODO
            return "";
        }

        public string Visit(VarDefList node){
            //TODO
            return "";
        }

        public string Visit(StmtList node){
            return VisitChildren((dynamic) node);
        }

        public string Visit(StmtIncr node){
            //TODO
            return "";
        }

        public string Visit(StmtDecr node){
            //TODO
            return "";
        }

        public string Visit(ExprList node){
            return VisitChildren((dynamic) node);
        }

        public string Visit(StmtIf node){
            //TODO
            return "";
        }

        public string Visit(ElseIfList node){
            //TODO
            return "";
        }

        public string Visit(Elif node){
            //TODO
            return "";
        }

        public string Visit(Else node){
            //TODO
            return "";
        }

        public string Visit(StmtWhile node){
            var label1 = GenerateLabel();
            var label2 = GenerateLabel();

            return $"block  {label1}\n"
            + $"  loop  {label2}\n"
            + Visit((dynamic) node[0])
            + "  i32.eqz\n"
            + $"  br_if {label1}\n"
            + Visit((dynamic) node[1])
            + $"  br {label2}\n"
            + "  end\n"
            + "end\n";
        }

        public string Visit(StmtDoWhile node){
            var label1 = GenerateLabel();
            var label2 = GenerateLabel();

            return $"block  {label1}\n"
            + $"  loop  {label2}\n"
            + Visit((dynamic) node[0])
            + Visit((dynamic) node[1])
            + "  i32.eqz\n"
            + $"  br_if {label1}\n"
            + $"  br {label2}\n"
            + "  end\n"
            + "end\n";
        }

        public string Visit(Break node){
            //TODO
            return "";
        }

        public string Visit(StmtReturn node){
            return Visit((dynamic) node[0]) + "  return\n"; 
        }

        public string Visit(Empty node){
            //TODO
            return "";
        }

        public string Visit(ExprOr node){
            //TODO
            return "";
        }

        public string Visit(ExprAnd node){
            //TODO
            return "";
        }

        public string Visit(Compare node) {
            return VisitChildren((dynamic) node) + "  i32.eq\n";
        }

        public string Visit(Different node) {
            return VisitChildren((dynamic) node) + "  i32.ne\n";
        }

        public string Visit(LessThan node) {
            return VisitChildren((dynamic) node) + "  i32.lt_s\n";
        }

        public string Visit(LessEqualThan node) {
            return VisitChildren((dynamic) node) + "  i32.le_s\n";
        }

        public string Visit(MoreThan node) {
            return VisitChildren((dynamic) node) + "  i32.gt_s\n";
        }

        public string Visit(MoreEqualThan node) {
            return VisitChildren((dynamic) node) + "  i32.ge_s\n";
        }

        public string Visit(Plus node) {
            return VisitChildren((dynamic) node) + "  i32.add\n";
        }

        public string Visit(Less node) {
            return VisitChildren((dynamic) node) + "  i32.sub\n";
        }

        public string Visit(Multiply node) {
            return VisitChildren((dynamic) node) + "  i32.mul\n";
        }

        public string Visit(Division node) {
            return VisitChildren((dynamic) node) + "  i32.div_s\n";
        }

        public string Visit(Module node) {
            return VisitChildren((dynamic) node) + "  i32.rem_s\n";
        }

        public string Visit(ExprUnary node){
            //TODO
            return "";
        }

        public string Visit(Not node) {
            return "    i32.const 0\n"
                    + Visit((dynamic) node[0])
                    + "    i32.sub\n";
        }

        public string Visit(True node) {
            return "  i32.const 1\n";
        }
    
        public string Visit(False node) {
            return "  i32.const 0\n";
        }

        public string Visit (IntLiteral node) {
            var result = node.AnchorToken.Lexeme;
            return $"  i32.const {result}\n";
        }

        public string Visit(CharLit node){
            var result = char.ConvertToUtf32(node.AnchorToken.Lexeme, 0);
            return $"  i32.const {result}\n";
        }

        public string Visit(StringLit node){
            var sb = new StringBuilder();
            var lstString = AsCodePoints(node.AnchorToken.Lexeme);
            
            sb.Append("  (local $_temp i32)\n"
                    + "  (local $s i32)\n"
                    + "  i32.const 0\n"
                    + "  call $new\n"
                    + "  local.set $_temp\n"
                    + "  local.get $_temp\n");

            foreach(var c in lstString) {
                sb.Append("  local.get $_temp\n");
            }

            sb.Append("\n");

            foreach(var c in lstString){
                sb.Append($"  i32.const {c}\n"
                         + "  call $add\n"
                         + "  drop\n"
                         + "\n");
            }

            sb.Append("  local.set $s\n");

            return sb.ToString();
        }

        public string Visit(Assign node){
            //TODO
            return "";
        }

        public string Visit(FunCall node){
            var sb = new StringBuilder();

            sb.Append(VisitChildren((dynamic) node) + $"  call ${node.AnchorToken.Lexeme}\n");

            return sb.ToString();
        }

        public string Visit(ParametersList node){
            //TODO
            return "";
        }

        public string VisitChildren(Node node){
            var sb = new StringBuilder();

            foreach (var n in node) {
                sb.Append(Visit((dynamic) n));
            }
            
            return sb.ToString();
		}

        public static IList<int> AsCodePoints(String str) {
            var result = new List<int>(str.Length - 2);

            for (var i = 1; i < str.Length - 1; i++) {
                result.Add(char.ConvertToUtf32(str, i));
                
                if (char.IsHighSurrogate(str, i)) {
                    i++;
                }
            }
            return result;
        }
    }
}